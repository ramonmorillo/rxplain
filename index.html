<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RxPlain ¬∑ Traducci√≥n farmacoterap√©utica</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#eaf0ff;
      --accent:#6aa6ff; --border:rgba(255,255,255,.10);
      --paper:#ffffff; --ink:#0b1220;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#070b14);color:var(--text)}
    header{padding:24px 16px;border-bottom:1px solid var(--border)}
    header h1{margin:0;font-size:18px;letter-spacing:.2px}
    header p{margin:8px 0 0;color:var(--muted);font-size:13px;max-width:980px;line-height:1.35}
    main{max-width:1150px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:rgba(17,26,46,.82);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px;font-size:15px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:#0b1326;color:var(--text);outline:none
    }
    textarea{min-height:88px;resize:vertical;line-height:1.35}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){.row{grid-template-columns:1fr 1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(106,166,255,.15);color:var(--text);cursor:pointer;font-weight:600
    }
    button.secondary{background:rgba(255,255,255,.06)}
    button.danger{background:rgba(251,113,133,.12)}
    .tiny{font-size:11px;color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .pill b{color:var(--text)}
    hr{border:0;border-top:1px solid var(--border);margin:12px 0}

    /* CIMA results */
    .resultItem{
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px;
      margin:8px 0;
      background:rgba(255,255,255,.05);
      cursor:pointer;
    }
    .resultItem:hover{background:rgba(106,166,255,.10)}
    .resultTitle{font-weight:700;color:var(--text);font-size:13px}
    .resultMeta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.3}

    /* OUTPUT */
    #outputWrap{display:none}
    .infografia{background:var(--paper);color:var(--ink);border-radius:18px;padding:18px}
    .infografia h3{margin:0 0 6px;font-size:18px}
    .sub{margin:0 0 14px;color:#334155;font-size:13px;line-height:1.35}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(2,6,23,.18);color:#0f172a;background:rgba(2,6,23,.03)}
    .tag.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.06)}
    .tag.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08)}
    .tag.danger{border-color:rgba(225,29,72,.35);background:rgba(225,29,72,.06)}

    /* Alineaci√≥n por medicamento */
    .medGrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media(min-width:980px){
      .medGrid{grid-template-columns:1.2fr 1fr 1fr 1fr}
      .medHead{display:block}
    }
    .medHead{
      display:none;font-size:12px;font-weight:700;color:#0f172a;
      padding:10px 12px;border:1px solid rgba(2,6,23,.12);
      border-radius:14px;background:rgba(2,6,23,.03);
    }
    .cell{border:1px solid rgba(2,6,23,.15);border-radius:16px;padding:12px;background:#fff;min-height:110px}
    .cell h4{margin:0 0 6px;font-size:13px;color:#0f172a}
    .cell ul{margin:0;padding-left:18px}
    .cell li{margin:6px 0;font-size:12.5px;line-height:1.25;color:#0f172a}
    .iconBadge{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border-radius:10px;
      background:rgba(2,6,23,.06);margin-right:8px;font-size:14px
    }
    .medTitle{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .medName{font-weight:800;font-size:13px}

    a{color:#2563eb;text-decoration:none}
    a:hover{text-decoration:underline}
    .foot{margin-top:14px;font-size:11px;color:#475569}

    .notice{
      border-left:3px solid rgba(106,166,255,.65);
      padding:10px 12px;background:rgba(106,166,255,.08);
      border-radius:12px;color:var(--text);font-size:12px
    }

    .kbd{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:11px;padding:2px 6px;border:1px solid rgba(255,255,255,.18);
      border-radius:8px;color:var(--muted)
    }
  </style>
</head>

<body>
<header>
  <h1>RxPlain ¬∑ Traducci√≥n farmacoterap√©utica a pacientes</h1>
  <p>
    Convierte tratamientos completos (a partir de ficha t√©cnica/SmPC y tu criterio cl√≠nico) en una infograf√≠a clara, priorizada y √∫til.
    <span class="kbd">Sin pago</span> ¬∑ <span class="kbd">GitHub Pages</span> ¬∑ <span class="kbd">CIMA (AEMPS) opcional</span>
  </p>
</header>

<main class="grid">
  <!-- PERFIL + PERSONALIZACI√ìN -->
  <section class="card">
    <h2>1) Perfil del paciente (y personalizaci√≥n opcional)</h2>

    <div class="row">
      <div>
        <label>Edad</label>
        <select id="age">
          <option value="joven">Joven</option>
          <option value="adulto" selected>Adulto</option>
          <option value="mayor">Mayor</option>
        </select>
      </div>

      <div>
        <label>Tipo de proceso</label>
        <select id="course">
          <option value="agudo">Agudo</option>
          <option value="cronico" selected>Cr√≥nico</option>
        </select>
      </div>

      <div>
        <label>Alfabetizaci√≥n en salud</label>
        <select id="lit">
          <option value="baja">Baja</option>
          <option value="media" selected>Media</option>
          <option value="alta">Alta</option>
        </select>
      </div>

      <div>
        <label>Contexto</label>
        <select id="ctx">
          <option value="general" selected>General</option>
          <option value="laboral">Laboral activo</option>
          <option value="cuidador">Cuidador</option>
          <option value="jubilado">Jubilado</option>
        </select>
      </div>
    </div>

    <label>Indicaci√≥n / problema de salud principal (nivel tratamiento)</label>
    <input id="indication" placeholder="Ej.: Riesgo cardiovascular elevado / VIH / EPOC / Diabetes tipo 2"/>

    <label>Objetivos en salud (nivel tratamiento; 2‚Äì4 bullets)</label>
    <textarea id="goals" placeholder="- Controlar presi√≥n arterial y LDL&#10;- Reducir riesgo de eventos cardiovasculares&#10;- Minimizar efectos adversos y facilitar adherencia"></textarea>

    <label>Objetivo educativo (1 frase)</label>
    <input id="edu_goal" placeholder="Ej.: Integrar el tratamiento en 2 momentos del d√≠a y reconocer se√±ales de alarma reales." />

    <div class="notice" style="margin-top:12px">
      Personalizaci√≥n opcional (para entregar al paciente). Si lo dejas en blanco, no aparece.
    </div>

    <div class="row">
      <div>
        <label>Nombre del farmac√©utico/a (opcional)</label>
        <input id="pharm_name" placeholder="Ej.: Ram√≥n Morillo"/>
      </div>
      <div>
        <label>Servicio/centro (opcional)</label>
        <input id="center" placeholder="Ej.: Servicio de Farmacia ¬∑ Hospital ..."/>
      </div>
      <div>
        <label>Contacto (opcional)</label>
        <input id="contact" placeholder="Ej.: Tel√©fono / email / extensi√≥n"/>
      </div>
      <div>
        <label>Fecha (opcional)</label>
        <input id="date" placeholder="Ej.: 4 feb 2026"/>
      </div>
    </div>
  </section>

  <!-- TRATAMIENTO -->
  <section class="card">
    <h2>2) Tratamiento completo</h2>
    <p class="tiny">
      Puedes a√±adir medicamentos manualmente o buscarlos en <b>CIMA (AEMPS)</b>.
      La herramienta no ‚Äúdecide‚Äù por ti: t√∫ sigues controlando posolog√≠a, normal/notar y avisar.
    </p>

    <!-- CIMA SEARCH -->
    <label>Buscar medicamento en CIMA (AEMPS) (opcional)</label>
    <input id="cima_query" placeholder="Escribe al menos 3 letras (ej.: atorvast...)" />
    <div id="cima_results" class="tiny" style="margin-top:8px"></div>

    <hr>

    <div class="row">
      <div>
        <label>Nombre del medicamento</label>
        <input id="m_name" placeholder="Ej.: atorvastatina"/>
      </div>
      <div>
        <label>Para qu√© sirve (en este paciente)</label>
        <input id="m_ind" placeholder="Ej.: bajar LDL y reducir riesgo CV"/>
      </div>
      <div>
        <label>C√≥mo se toma (posolog√≠a / instrucciones)</label>
        <input id="m_dose" placeholder="Ej.: 1 vez al d√≠a por la noche, con o sin comida"/>
      </div>
      <div>
        <label>Mensaje clave (beneficio en 1 frase, opc.)</label>
        <input id="m_benefit" placeholder="Ej.: ayuda a prevenir infarto e ictus a largo plazo"/>
      </div>
    </div>

    <label>Qu√© es normal notar (3‚Äì6 bullets)</label>
    <textarea id="m_ae" placeholder="- Molestias digestivas leves al inicio&#10;- Mareo leve al levantarse"></textarea>

    <label>Cu√°ndo avisar (2‚Äì4 bullets; se√±ales de alarma reales)</label>
    <textarea id="m_warn" placeholder="- Dolor muscular intenso o debilidad marcada&#10;- Hinchaz√≥n de cara/labios o dificultad para respirar"></textarea>

    <label>Notas/precauciones o interacciones (opc.; 1‚Äì4 bullets)</label>
    <textarea id="m_notes" placeholder="- Evitar pomelo en grandes cantidades&#10;- Avisar si se a√±aden antibi√≥ticos nuevos"></textarea>

    <div class="btns">
      <button id="addMed">A√±adir medicamento</button>
      <button class="secondary" id="loadExample">Cargar ejemplo (3 f√°rmacos)</button>
      <button class="danger" id="clearAll">Borrar todo</button>
    </div>

    <hr>
    <div class="pill">Medicamentos a√±adidos: <b id="count">0</b></div>
    <div id="medList" class="tiny" style="margin-top:8px;line-height:1.5"></div>

    <div class="btns">
      <button id="generate">Generar infograf√≠a</button>
      <button class="secondary" id="print" disabled>Imprimir / Guardar PDF</button>
    </div>
  </section>

  <!-- SALIDA -->
  <section class="card" id="outputWrap">
    <h2>3) Infograf√≠a (alineada por medicamento)</h2>
    <div class="tiny">Tip: usa ‚ÄúImprimir / Guardar PDF‚Äù para obtener un PDF desde el navegador.</div>
    <hr>
    <div id="output" class="infografia" aria-label="Infograf√≠a RxPlain"></div>
  </section>
</main>

<script>
  // ======================
  // Core tool state
  // ======================
  const meds = [];
  const $ = (id)=>document.getElementById(id);

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function sanitizeLines(text, max=8){
    return (text||"")
      .split("\n")
      .map(s=>s.trim())
      .filter(Boolean)
      .slice(0, max);
  }

  function renderMedList(){
    $("count").textContent = meds.length.toString();
    $("medList").innerHTML = meds.map((m,i)=>{
      const src = m.cima?.nregistro ? ` ¬∑ CIMA nregistro ${escapeHtml(m.cima.nregistro)}` : "";
      return `‚Ä¢ [${i+1}] <b>${escapeHtml(m.name)}</b> ‚Äî ${escapeHtml(m.dose||"")}${src}`;
    }).join("<br>");
  }

  function resetMedInputs(){
    ["m_name","m_ind","m_dose","m_benefit","m_ae","m_warn","m_notes"].forEach(id=>$(id).value="");
    $("m_name").focus();
  }

  function addMedication(obj){
    meds.push(obj);
    renderMedList();
  }

  function computeTags(){
    const course = $("course").value;
    const lit = $("lit").value;
    const hasWarn = meds.some(m=>m.warn?.length);
    const hasNormal = meds.some(m=>m.ae?.length);

    const tags = [];
    tags.push(course==="cronico" ? {t:"Cr√≥nico", cls:"ok"} : {t:"Agudo", cls:"ok"});
    tags.push({t:`${meds.length} f√°rmacos`, cls:""});
    tags.push({t:`Alfabetizaci√≥n: ${lit}`, cls:""});
    if (hasWarn) tags.push({t:"Alertas presentes", cls:"danger"});
    if (hasNormal) tags.push({t:"Efectos esperables", cls:"warn"});
    const anyCima = meds.some(m=>m.cima?.nregistro);
    if (anyCima) tags.push({t:"CIMA (AEMPS)", cls:""});
    return tags;
  }

  function pickTopMessages(){
    // M√°ximo 3 mensajes prioritarios: warnings primero, luego beneficios
    const scored = meds.map(m=>{
      let s=0;
      if ((m.warn||[]).length) s+=5;
      if ((m.benefit||"").length>20) s+=2;
      if ((m.notes||[]).length) s+=1;
      return {m,s};
    }).sort((a,b)=>b.s-a.s);

    return scored.slice(0,3).map(x=>{
      const m=x.m;
      const w=(m.warn||[])[0];
      const b=(m.benefit||"");
      if (w) return `Prioridad: <b>${escapeHtml(m.name)}</b> ‚Äî vigilar: ${escapeHtml(w)}`;
      if (b) return `Clave: <b>${escapeHtml(m.name)}</b> ‚Äî ${escapeHtml(b)}`;
      return `Clave: <b>${escapeHtml(m.name)}</b>`;
    });
  }

  function buildOutput(){
    const course = $("course").value;
    const indication = $("indication").value.trim();
    const goals = sanitizeLines($("goals").value, 6);
    const eduGoal = $("edu_goal").value.trim();

    // Personalizaci√≥n (opcional)
    const pharmName = $("pharm_name").value.trim();
    const center = $("center").value.trim();
    const contact = $("contact").value.trim();
    const date = $("date").value.trim();

    const headerLines = [];
    if (indication) headerLines.push(`<b>Indicaci√≥n principal:</b> ${escapeHtml(indication)}`);
    if (goals.length) headerLines.push(`<b>Objetivos en salud:</b> ${goals.map(g=>escapeHtml(g)).join(" ¬∑ ")}`);
    if (eduGoal) headerLines.push(`<b>Objetivo educativo:</b> ${escapeHtml(eduGoal)}`);
    if (!headerLines.length) headerLines.push(`Informaci√≥n adaptada para facilitar el uso correcto del tratamiento.`);

    const tags = computeTags();
    const topMsgs = pickTopMessages();

    const head = `
      <div class="medHead">Medicamento</div>
      <div class="medHead">C√≥mo tomarlo</div>
      <div class="medHead">Qu√© es normal notar</div>
      <div class="medHead">Cu√°ndo avisar</div>
    `;

    const rows = meds.map(m=>{
      const ae = (m.ae||[]).length ? (m.ae||[]) : ["Si notas molestias leves al inicio, suele ser transitorio."];
      const warn = (m.warn||[]).length ? (m.warn||[]) : ["Si aparece un s√≠ntoma intenso o persistente, consulta."];
      const notes = (m.notes||[]).slice(0,3);

      const cimaLine = m.cima?.nregistro
        ? `<li><b>Fuente:</b> <a href="${escapeHtml(m.cima.url)}" target="_blank" rel="noopener">CIMA (AEMPS)</a> ¬∑ nregistro ${escapeHtml(m.cima.nregistro)}</li>`
        : "";

      return `
        <div class="cell">
          <div class="medTitle"><span class="iconBadge">üíä</span><div class="medName">${escapeHtml(m.name)}</div></div>
          <ul>
            ${m.indication ? `<li><b>Para qu√©:</b> ${escapeHtml(m.indication)}</li>` : ""}
            ${m.benefit ? `<li><b>Clave:</b> ${escapeHtml(m.benefit)}</li>` : ""}
            ${notes.length ? `<li><b>Precauciones:</b> ${notes.map(n=>escapeHtml(n)).join(" ¬∑ ")}</li>` : ""}
            ${cimaLine}
          </ul>
        </div>

        <div class="cell">
          <h4><span class="iconBadge">üïí</span>C√≥mo tomarlo</h4>
          <ul>
            ${m.dose ? `<li>${escapeHtml(m.dose)}</li>` : `<li>Seg√∫n pauta indicada por tu equipo sanitario.</li>`}
            ${course==="cronico" ? `<li>La regularidad es m√°s importante que hacerlo ‚Äúperfecto‚Äù.</li>` : `<li>Completa la duraci√≥n indicada aunque mejores.</li>`}
          </ul>
        </div>

        <div class="cell">
          <h4><span class="iconBadge">üôÇ</span>Qu√© es normal notar</h4>
          <ul>
            ${ae.slice(0,6).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
          </ul>
        </div>

        <div class="cell">
          <h4><span class="iconBadge">üö®</span>Cu√°ndo avisar</h4>
          <ul>
            ${warn.slice(0,6).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
          </ul>
        </div>
      `;
    }).join("");

    const contactBlock = (pharmName || center || contact || date) ? `
      <div style="margin-top:14px;border:1px solid rgba(2,6,23,.12);border-radius:14px;padding:10px 12px;background:rgba(2,6,23,.03)">
        <div style="font-size:12px;color:#0f172a;margin-bottom:6px"><b>Tu referencia de contacto</b></div>
        <div style="font-size:12px;color:#0f172a;line-height:1.4">
          ${pharmName ? `<div><b>Farmac√©utico/a:</b> ${escapeHtml(pharmName)}</div>` : ""}
          ${center ? `<div><b>Centro/Servicio:</b> ${escapeHtml(center)}</div>` : ""}
          ${contact ? `<div><b>Contacto:</b> ${escapeHtml(contact)}</div>` : ""}
          ${date ? `<div><b>Fecha:</b> ${escapeHtml(date)}</div>` : ""}
        </div>
      </div>
    ` : "";

    const sourcesBlock = `
      <div style="margin-top:16px;border-top:1px dashed rgba(2,6,23,.25);padding-top:12px">
        <h4 style="margin:0 0 6px;font-size:13px">Fuentes y recursos fiables</h4>
        <ul style="margin:0;padding-left:18px;font-size:12px;color:#334155;line-height:1.4">
          <li><a href="https://www.ema.europa.eu/" target="_blank" rel="noopener">Agencia Europea del Medicamento (EMA)</a></li>
          <li><a href="https://www.aemps.gob.es/" target="_blank" rel="noopener">Agencia Espa√±ola de Medicamentos y Productos Sanitarios (AEMPS)</a></li>
          <li><a href="https://cima.aemps.es/" target="_blank" rel="noopener">CIMA ‚Äì Centro de Informaci√≥n online de Medicamentos (AEMPS)</a></li>
          <li><a href="https://www.sefh.es/" target="_blank" rel="noopener">Sociedad Espa√±ola de Farmacia Hospitalaria (SEFH)</a></li>
          <li><a href="https://www.sefh.es/escuela-de-pacientes.php" target="_blank" rel="noopener">Escuela de Pacientes de la SEFH</a></li>
        </ul>
      </div>
    `;

    return `
      <h3>Tu tratamiento, explicado de forma clara</h3>
      <p class="sub">${headerLines.join("<br>")}</p>

      <div class="tags">
        ${tags.slice(0,6).map(x=>`<span class="tag ${x.cls||""}">${escapeHtml(x.t)}</span>`).join("")}
      </div>

      <div style="border:1px solid rgba(2,6,23,.12);border-radius:14px;padding:10px 12px;background:rgba(2,6,23,.03)">
        <div style="font-size:12px;color:#0f172a;margin-bottom:6px"><b>Mensajes prioritarios (m√°x. 3)</b></div>
        <ul style="margin:0;padding-left:18px">
          ${topMsgs.length ? topMsgs.map(x=>`<li style="font-size:12px;margin:6px 0">${x}</li>`).join("") : `<li style="font-size:12px;margin:6px 0">Integra el tratamiento en una rutina estable.</li>`}
        </ul>
      </div>

      <div class="medGrid">
        ${head}
        ${rows}
      </div>

      ${contactBlock}
      ${sourcesBlock}

      <p class="foot">
        RxPlain ¬∑ Versi√≥n 0.4 ¬∑ ¬© Ram√≥n Morillo, febrero 2026 ¬∑
        Material informativo adaptado al perfil indicado. No sustituye la consulta con profesionales sanitarios.
      </p>
    `;
  }

  // ======================
  // Events: add/generate/print
  // ======================
  $("addMed").addEventListener("click", ()=>{
    const name = $("m_name").value.trim();
    if (!name) { alert("Falta el nombre del medicamento."); return; }

    // Integraci√≥n CIMA: si el usuario ha seleccionado un medicamento de CIMA recientemente, lo asociamos.
    const cima = window.__lastCima ? { ...window.__lastCima } : null;

    addMedication({
      name,
      indication: $("m_ind").value.trim(),
      dose: $("m_dose").value.trim(),
      benefit: $("m_benefit").value.trim(),
      ae: sanitizeLines($("m_ae").value, 8),
      warn: sanitizeLines($("m_warn").value, 8),
      notes: sanitizeLines($("m_notes").value, 6),
      cima: (cima && cima.nombre && (cima.nombre.toLowerCase().includes(name.toLowerCase()) || name.toLowerCase().includes(cima.nombre.toLowerCase())))
        ? { nregistro: cima.nregistro, url: cima.url_cima }
        : (cima ? { nregistro: cima.nregistro, url: cima.url_cima } : null)
    });

    // Limpia selecci√≥n CIMA despu√©s de a√±adir para evitar asignaciones accidentales
    window.__lastCima = null;
    $("cima_results").innerHTML = `<div class="tiny">Puedes buscar otro medicamento en CIMA.</div>`;

    resetMedInputs();
  });

  $("generate").addEventListener("click", ()=>{
    if (meds.length===0){ alert("A√±ade al menos 1 medicamento."); return; }
    $("output").innerHTML = buildOutput();
    $("outputWrap").style.display = "block";
    $("print").disabled = false;
    $("outputWrap").scrollIntoView({behavior:"smooth", block:"start"});
  });

  $("print").addEventListener("click", ()=>{
    const content = $("output").outerHTML;
    const w = window.open("", "_blank");
    w.document.write(`
      <html><head><title>RxPlain - PDF</title>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <style>
        body{margin:0;padding:18px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f1f5f9}
        .infografia{background:#fff;border-radius:18px;padding:18px}
        .tags{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
        .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(2,6,23,.18);color:#0f172a;background:rgba(2,6,23,.03)}
        .tag.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.06)}
        .tag.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08)}
        .tag.danger{border-color:rgba(225,29,72,.35);background:rgba(225,29,72,.06)}
        .medGrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
        @media(min-width:980px){.medGrid{grid-template-columns:1.2fr 1fr 1fr 1fr}.medHead{display:block}}
        .medHead{display:none;font-size:12px;font-weight:700;color:#0f172a;padding:10px 12px;border:1px solid rgba(2,6,23,.12);border-radius:14px;background:rgba(2,6,23,.03)}
        .cell{border:1px solid rgba(2,6,23,.15);border-radius:16px;padding:12px;background:#fff;min-height:110px}
        .cell h4{margin:0 0 6px;font-size:13px;color:#0f172a}
        .cell ul{margin:0;padding-left:18px}
        .cell li{margin:6px 0;font-size:12.5px;line-height:1.25;color:#0f172a}
        .iconBadge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:10px;background:rgba(2,6,23,.06);margin-right:8px;font-size:14px}
        .medTitle{display:flex;align-items:center;gap:8px;margin-bottom:6px}
        .medName{font-weight:800;font-size:13px}
        .sub{margin:0 0 14px;color:#334155;font-size:13px;line-height:1.35}
        .foot{margin-top:14px;font-size:11px;color:#475569}
        a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
      </style></head><body>${content}</body></html>
    `);
    w.document.close();
    w.focus();
    w.print();
  });

  $("clearAll").addEventListener("click", ()=>{
    meds.length = 0;
    renderMedList();
    $("outputWrap").style.display="none";
    $("print").disabled = true;

    // Limpiar inputs de tratamiento
    resetMedInputs();
    $("cima_query").value = "";
    $("cima_results").innerHTML = "";

    // Limpiar inputs de perfil
    $("indication").value = "";
    $("goals").value = "";
    $("edu_goal").value = "";

    // Limpiar selecci√≥n CIMA
    window.__lastCima = null;
  });

  $("loadExample").addEventListener("click", ()=>{
    meds.length=0;

    addMedication({
      name:"Atorvastatina",
      indication:"Reducir colesterol LDL y bajar el riesgo cardiovascular",
      dose:"1 vez al d√≠a, preferentemente por la noche, con o sin comida",
      benefit:"Ayuda a prevenir infarto e ictus a largo plazo",
      ae:["Molestias digestivas leves al inicio","Dolor muscular leve (si aparece, com√©ntalo)"],
      warn:["Dolor muscular intenso o debilidad marcada","Ictericia u orina muy oscura"],
      notes:["Evitar pomelo en grandes cantidades","Avisar si se a√±aden antibi√≥ticos nuevos"],
      cima:null
    });

    addMedication({
      name:"Enalapril/Hidroclorotiazida",
      indication:"Controlar la presi√≥n arterial",
      dose:"1 vez al d√≠a por la ma√±ana",
      benefit:"Reduce el riesgo de complicaciones por hipertensi√≥n",
      ae:["Mareo al inicio (lev√°ntate despacio)","Aumento de la diuresis"],
      warn:["Hinchaz√≥n de cara/labios o dificultad para respirar","Desmayo o mareo intenso persistente"],
      notes:["Hidrataci√≥n adecuada","Control anal√≠tico seg√∫n indicaci√≥n m√©dica"],
      cima:null
    });

    addMedication({
      name:"Metformina",
      indication:"Mejorar control de glucosa en diabetes tipo 2",
      dose:"Con comidas (desayuno y/o cena), seg√∫n pauta",
      benefit:"Ayuda a controlar el az√∫car y protege a largo plazo",
      ae:["N√°useas o diarrea al inicio (suele mejorar)"],
      warn:["V√≥mitos persistentes o gran debilidad","S√≠ntomas intensos tras deshidrataci√≥n"],
      notes:["Tomarla con comida reduce molestias","En pruebas con contraste, avisa al equipo sanitario"],
      cima:null
    });

    $("age").value="adulto";
    $("course").value="cronico";
    $("lit").value="media";
    $("ctx").value="general";
    $("indication").value="Riesgo cardiovascular elevado";
    $("goals").value="- Controlar presi√≥n arterial y LDL\n- Reducir riesgo de eventos cardiovasculares\n- Facilitar adherencia y minimizar efectos adversos";
    $("edu_goal").value="Integra el tratamiento en 2 momentos del d√≠a y reconoce se√±ales de alarma reales sin alarmismo.";

    renderMedList();
    $("cima_results").innerHTML = `<div class="tiny">Si quieres, prueba a buscar en CIMA: escribe ‚Äúatorv‚Äù o ‚Äúmetfor‚Äù.</div>`;
  });

  // ======================
  // CIMA (AEMPS) Integration
  // ======================
  const CIMA_BASE = "https://cima.aemps.es/cima/rest";

  function debounce(fn, ms){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  }

  async function cimaSearchByName(q){
    const url = `${CIMA_BASE}/medicamentos?nombre=${encodeURIComponent(q)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("No se pudo consultar CIMA");
    return res.json();
  }

  async function cimaGetByNregistro(nregistro){
    const url = `${CIMA_BASE}/medicamento?nregistro=${encodeURIComponent(nregistro)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("No se pudo obtener detalle del medicamento");
    return res.json();
  }

  function renderCimaResults(items){
    const box = $("cima_results");
    if (!items || !items.length){
      box.innerHTML = `<div class="tiny">Sin resultados.</div>`;
      return;
    }

    box.innerHTML = items.slice(0, 8).map((m)=>`
      <div class="resultItem" data-nregistro="${escapeHtml(m.nregistro||"")}">
        <div class="resultTitle">${escapeHtml(m.nombre || "Medicamento")}</div>
        <div class="resultMeta">
          nregistro: ${escapeHtml(m.nregistro || "‚Äî")}
          ${m.pactivos ? ` ¬∑ PA: ${escapeHtml(m.pactivos)}` : ""}
        </div>
      </div>
    `).join("");

    [...box.querySelectorAll(".resultItem")].forEach(el=>{
      el.addEventListener("click", async ()=>{
        const nregistro = el.getAttribute("data-nregistro");
        if (!nregistro) return;
        try{
          const detail = await cimaGetByNregistro(nregistro);
          // Rellenar al menos el nombre; el resto lo sigue completando el farmac√©utico
          $("m_name").value = detail.nombre || "";

          // Guardar selecci√≥n para asociarla al siguiente "A√±adir medicamento"
          window.__lastCima = {
            nregistro,
            nombre: detail.nombre || "",
            url_cima: `https://cima.aemps.es/cima/publico/home.html#medicamento?${encodeURIComponent(nregistro)}`
          };

          box.innerHTML = `<div class="tiny">Seleccionado: <b>${escapeHtml(detail.nombre || "")}</b> (nregistro ${escapeHtml(nregistro)}). Ahora completa los campos y pulsa ‚ÄúA√±adir medicamento‚Äù.</div>`;
        }catch(e){
          alert("Error al cargar detalle desde CIMA. " + e.message);
        }
      });
    });
  }

  const onCimaInput = debounce(async ()=>{
    const q = $("cima_query").value.trim();
    const box = $("cima_results");
    if (q.length < 3){
      box.innerHTML = `<div class="tiny">Escribe al menos 3 letras para buscar.</div>`;
      return;
    }
    box.innerHTML = `<div class="tiny">Buscando en CIMA‚Ä¶</div>`;
    try{
      const data = await cimaSearchByName(q);
      // Normalmente devuelve array; dejamos fallback por si cambia
      const items = Array.isArray(data) ? data : (data?.resultados || data?.items || []);
      renderCimaResults(items);
    }catch(e){
      box.innerHTML = `<div class="tiny">No se pudo consultar CIMA. Si persiste, revisa conexi√≥n o prueba m√°s tarde.</div>`;
    }
  }, 350);

  $("cima_query").addEventListener("input", onCimaInput);

  // Init
  $("cima_results").innerHTML = `<div class="tiny">Escribe un nombre para buscar en CIMA (opcional).</div>`;
</script>
</body>
</html>
